<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Find the right SF Tech Week events</title>
    <style>
      * { box-sizing: border-box; }
      
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
        margin: 0; 
        background: #2c3424;
        color: #daded8; 
        min-height: 100vh;
        line-height: 1.6;
      }
      
      .wrap { 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 40px 24px; 
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      
      .header {
        margin-bottom: 40px;
      }
      
      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .logo-img {
        height: 40px;
        width: auto;
      }
      
      .logo-text {
        font-size: 24px;
        font-weight: 700;
        color: #daded8;
        letter-spacing: 2px;
      }
      
      .footer {
        margin-top: 60px;
        text-align: center;
        padding: 20px 0;
        border-top: 1px solid rgba(218, 222, 216, 0.2);
      }
      
      .footer p {
        color: rgba(218, 222, 216, 0.7);
        font-size: 14px;
        margin: 0;
      }
      
      .shezaar-link {
        color: #daded8;
        text-decoration: none;
        font-weight: 600;
        border-bottom: 1px solid transparent;
        transition: all 0.3s ease;
      }
      
      .shezaar-link:hover {
        border-bottom-color: #daded8;
        color: #daded8;
      }
      
      .card { 
        background: rgba(76, 88, 62, 0.3); 
        backdrop-filter: blur(20px);
        border: 1px solid rgba(218, 222, 216, 0.2); 
        border-radius: 20px; 
        padding: 32px; 
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
      }
      
      h1 { 
        font-size: 28px; 
        margin: 0 0 16px; 
        color: #daded8;
        font-weight: 700;
      }
      
      .subtitle {
        color: rgba(218, 222, 216, 0.8);
        font-size: 16px;
        margin-bottom: 24px;
        line-height: 1.5;
      }
      
      textarea { 
        width: 100%; 
        min-height: 140px; 
        border-radius: 12px; 
        border: 2px solid rgba(218, 222, 216, 0.3); 
        background: rgba(44, 52, 36, 0.6); 
        color: #daded8; 
        padding: 16px; 
        resize: vertical; 
        font-size: 16px;
        font-family: inherit;
        transition: all 0.3s ease;
        outline: none;
      }
      
      textarea:focus {
        border-color: #daded8;
        box-shadow: 0 0 0 3px rgba(218, 222, 216, 0.2);
        background: rgba(44, 52, 36, 0.8);
      }
      
      textarea::placeholder {
        color: rgba(218, 222, 216, 0.6);
      }
      
      .row { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
        margin-top: 20px; 
        flex-wrap: wrap;
      }
      
      button { 
        background: #daded8;
        color: #2c3424; 
        border: none; 
        padding: 14px 24px; 
        border-radius: 12px; 
        cursor: pointer; 
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(218, 222, 216, 0.3);
      }
      
      button:hover:not([disabled]) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(218, 222, 216, 0.4);
        background: rgba(218, 222, 216, 0.9);
      }
      
      button[disabled] { 
        opacity: 0.6; 
        cursor: not-allowed;
        transform: none;
      }
      
      .status {
        color: rgba(218, 222, 216, 0.8);
        font-size: 14px;
        font-style: italic;
      }
      
      .results { 
        margin-top: 32px; 
        animation: fadeIn 0.5s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .event { 
        padding: 20px; 
        border-bottom: 1px solid rgba(218, 222, 216, 0.2); 
        transition: all 0.3s ease;
        border-radius: 8px;
        margin-bottom: 8px;
        background: rgba(76, 88, 62, 0.2);
      }
      
      .event:hover {
        background: rgba(76, 88, 62, 0.4);
        transform: translateX(4px);
      }
      
      .event:last-child { 
        border-bottom: 0; 
        margin-bottom: 0;
      }
      
      .event-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #daded8;
      }
      
      .event-meta {
        color: rgba(218, 222, 216, 0.8);
        font-size: 14px;
        margin-bottom: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      .event-description {
        color: rgba(218, 222, 216, 0.8);
        font-size: 14px;
        margin-bottom: 12px;
        line-height: 1.5;
        font-style: italic;
      }
      
      .event-host {
        color: rgba(218, 222, 216, 0.9);
        font-size: 14px;
        margin-bottom: 12px;
      }
      
      .event-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
      }
      
      .tag {
        background: rgba(218, 222, 216, 0.1);
        color: rgba(218, 222, 216, 0.9);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid rgba(218, 222, 216, 0.2);
      }
      
      .event-link {
        color: #daded8;
        text-decoration: none;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        border-bottom: 1px solid transparent;
      }
      
      .event-link:hover {
        color: #daded8;
        border-bottom-color: #daded8;
        transform: translateX(2px);
      }
      
      .prefs-display {
        background: rgba(76, 88, 62, 0.3);
        border: 1px solid rgba(218, 222, 216, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 13px;
        color: rgba(218, 222, 216, 0.8);
        overflow-x: auto;
      }
      
      .small { 
        color: rgba(218, 222, 216, 0.8); 
        font-size: 14px; 
      }
      
      .mono { 
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; 
      }
      
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(218, 222, 216, 0.3);
        border-radius: 50%;
        border-top-color: #daded8;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .error {
        background: rgba(218, 222, 216, 0.1);
        border: 1px solid rgba(218, 222, 216, 0.3);
        color: #daded8;
        padding: 12px;
        border-radius: 8px;
        margin-top: 16px;
      }
      
      .filters-container {
        background: rgba(76, 88, 62, 0.2);
        border: 1px solid rgba(218, 222, 216, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
      }
      
      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .filters-header h3 {
        margin: 0;
        font-size: 18px;
        color: #daded8;
      }
      
      .clear-filters-btn {
        background: transparent;
        color: rgba(218, 222, 216, 0.8);
        border: 1px solid rgba(218, 222, 216, 0.3);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .clear-filters-btn:hover {
        background: rgba(218, 222, 216, 0.1);
        color: #daded8;
      }
      
      .filters-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      
      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 150px;
      }
      
      .filter-group label {
        font-size: 14px;
        color: rgba(218, 222, 216, 0.9);
        font-weight: 500;
      }
      
      .filter-select {
        background: rgba(44, 52, 36, 0.6);
        border: 1px solid rgba(218, 222, 216, 0.3);
        color: #daded8;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .filter-select:focus {
        outline: none;
        border-color: #daded8;
        background: rgba(44, 52, 36, 0.8);
      }
      
      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(218, 222, 216, 0.2);
      }
      
      .results-header h3 {
        margin: 0;
        font-size: 20px;
        color: #daded8;
      }
      
      .sort-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .sort-container label {
        font-size: 14px;
        color: rgba(218, 222, 216, 0.9);
        font-weight: 500;
      }
      
      .sort-select {
        background: rgba(44, 52, 36, 0.6);
        border: 1px solid rgba(218, 222, 216, 0.3);
        color: #daded8;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .sort-select:focus {
        outline: none;
        border-color: #daded8;
        background: rgba(44, 52, 36, 0.8);
      }
      
      .ai-reasoning {
        background: rgba(76, 88, 62, 0.3);
        border: 1px solid rgba(218, 222, 216, 0.2);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
      }
      
      .ai-reasoning h4 {
        margin: 0 0 12px 0;
        color: #daded8;
        font-size: 16px;
      }
      
      .ai-reasoning .reasoning-content {
        color: rgba(218, 222, 216, 0.9);
        line-height: 1.5;
      }
      
      .event-reason {
        background: rgba(218, 222, 216, 0.1);
        border-left: 3px solid rgba(218, 222, 216, 0.3);
        padding: 8px 12px;
        margin: 8px 0;
        border-radius: 4px;
        font-style: italic;
        font-size: 13px;
      }
      
      .floating-outfit-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #daded8;
        color: #2c3424;
        border: none;
        padding: 16px 24px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(218, 222, 216, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
        animation: floatIn 0.5s ease-out;
        border: 2px solid rgba(44, 52, 36, 0.1);
      }
      
      .floating-outfit-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 35px rgba(218, 222, 216, 0.5);
        background: rgba(218, 222, 216, 0.95);
      }
      
      .floating-outfit-btn:active {
        transform: translateY(-1px) scale(1.02);
      }
      
      @keyframes floatIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      /* Outfit Recommendation Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      .modal-content {
        background: rgba(76, 88, 62, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(218, 222, 216, 0.3);
        border-radius: 20px;
        padding: 32px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        transform: translateY(20px) scale(0.95);
        transition: all 0.3s ease;
      }
      
      .modal-overlay.show .modal-content {
        transform: translateY(0) scale(1);
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(218, 222, 216, 0.2);
      }
      
      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #daded8;
        margin: 0;
      }
      
      .modal-close {
        background: transparent;
        border: none;
        color: rgba(218, 222, 216, 0.8);
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-close:hover {
        background: rgba(218, 222, 216, 0.1);
        color: #daded8;
      }
      
      .outfit-recommendation {
        background: rgba(44, 52, 36, 0.6);
        border: 1px solid rgba(218, 222, 216, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .outfit-recommendation h4 {
        margin: 0 0 12px 0;
        color: #daded8;
        font-size: 18px;
      }
      
      .outfit-recommendation p {
        margin: 0 0 16px 0;
        color: rgba(218, 222, 216, 0.9);
        line-height: 1.6;
      }
      
      .outfit-recommendation p:last-child {
        margin-bottom: 0;
      }
      
      .event-types {
        background: rgba(218, 222, 216, 0.1);
        border: 1px solid rgba(218, 222, 216, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
      }
      
      .event-types h5 {
        margin: 0 0 8px 0;
        color: #daded8;
        font-size: 14px;
        font-weight: 600;
      }
      
      .event-types .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .event-types .tag {
        background: rgba(218, 222, 216, 0.2);
        color: rgba(218, 222, 216, 0.9);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid rgba(218, 222, 216, 0.3);
      }
      
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid rgba(218, 222, 216, 0.2);
      }
      
      .modal-btn {
        background: #daded8;
        color: #2c3424;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(218, 222, 216, 0.3);
      }
      
      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(218, 222, 216, 0.4);
        background: rgba(218, 222, 216, 0.9);
      }
      
      .modal-btn.secondary {
        background: transparent;
        color: rgba(218, 222, 216, 0.8);
        border: 1px solid rgba(218, 222, 216, 0.3);
        box-shadow: none;
      }
      
      .modal-btn.secondary:hover {
        background: rgba(218, 222, 216, 0.1);
        color: #daded8;
        transform: none;
        box-shadow: none;
      }

      @media (max-width: 768px) {
        .wrap { padding: 20px 16px; }
        .card { padding: 24px; }
        h1 { font-size: 24px; }
        .row { flex-direction: column; align-items: stretch; }
        .logo-img { height: 32px; }
        .logo-text { font-size: 20px; }
        .footer { margin-top: 40px; }
        
        .filters-row {
          flex-direction: column;
          gap: 16px;
        }
        
        .filter-group {
          min-width: auto;
        }
        
        .results-header {
          flex-direction: column;
          gap: 12px;
          align-items: flex-start;
        }
        
        .sort-container {
          width: 100%;
          justify-content: space-between;
        }
        
        .floating-outfit-btn {
          bottom: 20px;
          right: 20px;
          padding: 14px 20px;
          font-size: 14px;
        }
        
        .modal-content {
          padding: 24px;
          margin: 10px;
        }
        
        .modal-title {
          font-size: 20px;
        }
        
        .modal-actions {
          flex-direction: column;
        }
        
        .modal-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="header">
        <div class="logo">
          <img src="./shezaar-logo.png" alt="Shezaar" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="logo-text" style="display: none;">SHEZAAR</div>
        </div>
      </header>
      
      <div class="card">
        <h1>Find Your Perfect SF Tech Week Events</h1>
        <p class="subtitle">Tell us about your goals and we'll recommend the most relevant events for you. Whether you're looking for investors, co-founders, talent, or just want to network with like-minded people.</p>
        <textarea id="input" placeholder="I am building a wellness tech platform. I want to attend events to meet angels and other co-founders. No preference for time or days."></textarea>
        <div class="row">
          <button id="go">Find Events</button>
          <span id="status" class="status"></span>
        </div>
      </div>

      <div id="out" class="card results" hidden>
        <div class="filters-container" id="filters" hidden>
          <div class="filters-header">
            <h3>Filters</h3>
            <button id="clear-filters" class="clear-filters-btn">Clear All</button>
          </div>
          <div class="filters-row">
            <div class="filter-group">
              <label>Day</label>
              <select id="day-filter" class="filter-select">
                <option value="">All Days</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Location</label>
              <select id="location-filter" class="filter-select">
                <option value="">All Locations</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Topic</label>
              <select id="topic-filter" class="filter-select">
                <option value="">All Topics</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="results-header">
          <h3 id="results-title">Recommended Events</h3>
          <div class="sort-container">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select" class="sort-select">
              <option value="relevance">Relevance</option>
              <option value="date">Date</option>
              <option value="time">Time</option>
              <option value="name">Name</option>
            </select>
          </div>
        </div>
        
        <div id="ai-reasoning" class="ai-reasoning" hidden>
          <h4>AI Reasoning</h4>
          <div id="reasoning-content"></div>
        </div>
        
        <div id="events"></div>
      </div>
      
      <!-- Floating Outfit Button -->
      <button id="outfit-btn" class="floating-outfit-btn" hidden>
        Find the Perfect Outfit
      </button>
      
      <!-- Outfit Recommendation Modal -->
      <div id="outfit-modal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Outfit Recommendation</h3>
            <button class="modal-close" id="modal-close">&times;</button>
          </div>
          
          <div id="outfit-content">
            <!-- Outfit recommendation content will be inserted here -->
          </div>
          
          <div class="modal-actions">
            <button class="modal-btn secondary" id="modal-close-btn">Close</button>
            <button class="modal-btn" id="get-another-outfit">Get Another Recommendation</button>
          </div>
        </div>
      </div>
      
      <footer class="footer">
        <p>Powered by the minds behind <a href="https://www.shezaar.com" target="_blank" rel="noopener" class="shezaar-link">Shezaar</a></p>
      </footer>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const btn = $('go');
      const outfitBtn = $('outfit-btn');
      const input = $('input');
      const status = $('status');
      const out = $('out');
      const filtersEl = $('filters');
      const eventsEl = $('events');
      const dayFilter = $('day-filter');
      const locationFilter = $('location-filter');
      const topicFilter = $('topic-filter');
      const sortSelect = $('sort-select');
      const clearFiltersBtn = $('clear-filters');
      const aiReasoningEl = $('ai-reasoning');
      const reasoningContentEl = $('reasoning-content');
      const outfitModal = $('outfit-modal');
      const outfitContent = $('outfit-content');
      const modalClose = $('modal-close');
      const modalCloseBtn = $('modal-close-btn');
      const getAnotherOutfitBtn = $('get-another-outfit');
      
      // Hide floating button initially
      outfitBtn.hidden = true;
      
      let allEvents = [];
      let filteredEvents = [];
      let aiReasoning = null;

      // Function to log user interactions to Supabase
      async function logInteraction(type, data) {
        try {
          await fetch('/api/log-interaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: type, // 'query', 'find_events', 'find_outfit'
              data: data,
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent
            })
          });
        } catch (error) {
          console.error('Failed to log interaction:', error);
        }
      }

      async function recommend() {
        const message = input.value.trim();
        if (!message) return;
        
        // Log the query and button click
        await logInteraction('query', { message });
        await logInteraction('find_events', { message });
        
        btn.disabled = true; status.innerHTML = '<div class="loading"></div> Finding the best events for you...';
        out.hidden = true; eventsEl.innerHTML = ''; filtersEl.hidden = true;
        outfitBtn.hidden = true; // Hide floating button during search
        try {
          const resp = await fetch('/api/recommend-events', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, limit: 100 })
          });
          const data = await resp.json();
          if (!data.ok) throw new Error(data.error || 'Failed');
          
          allEvents = data.results || [];
          filteredEvents = [...allEvents];
          aiReasoning = data.aiReasoning || null;
          
          if (allEvents.length > 0) {
            // Populate filter options
            populateFilters(allEvents);
            // Show filters and results
            filtersEl.hidden = false;
            renderEvents();
            renderAIReasoning();
            // Show floating outfit button
            outfitBtn.hidden = false;
          } else {
            eventsEl.innerHTML = `
              <div class="event">
                <div class="event-title">No Events Found</div>
                <div class="event-meta">
                  <span>${data.message || 'Try adjusting your search criteria or check back later for new events.'}</span>
                </div>
              </div>
            `;
          }
          
          out.hidden = false;
        } catch (e) {
          console.error('Error:', e);
          status.innerHTML = `<div class="error">Error: ${e.message}</div>`;
        } finally {
          btn.disabled = false; 
          if (!status.innerHTML.includes('error')) {
            status.textContent = '';
          }
        }
      }

      async function recommendOutfit() {
        const message = input.value.trim();
        if (!message) return;
        
        // Log the query and outfit button click
        await logInteraction('query', { message });
        await logInteraction('find_outfit', { message });
        
        outfitBtn.disabled = true; 
        status.innerHTML = '<div class="loading"></div> Finding the perfect outfit for you...';
        
        try {
          const resp = await fetch('/api/recommend-outfit', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });
          const data = await resp.json();
          if (!data.ok) throw new Error(data.error || 'Failed');
          
          // Display outfit recommendations in modal
          showOutfitModal(data);
          
        } catch (e) {
          console.error('Error:', e);
          status.innerHTML = `<div class="error">Error: ${e.message}</div>`;
        } finally {
          outfitBtn.disabled = false; 
          if (!status.innerHTML.includes('error')) {
            status.textContent = '';
          }
        }
      }
      
      function showOutfitModal(data) {
        const eventTypes = data.eventTypes || [];
        const eventTypeLabels = {
          'investor_meeting': 'Investor Meeting',
          'startup_pitch': 'Startup Pitch',
          'co_founder_meetup': 'Co-founder Meetup',
          'networking_event': 'Networking Event',
          'tech_meetup': 'Tech Meetup',
          'wellness_tech': 'Wellness Tech',
          'fintech': 'Fintech',
          'ai_ml': 'AI/ML',
          'sustainability': 'Sustainability',
          'healthcare_tech': 'Healthcare Tech'
        };
        
        outfitContent.innerHTML = `
          ${eventTypes.length > 0 ? `
            <div class="event-types">
              <h5>Detected Event Types:</h5>
              <div class="tags">
                ${eventTypes.map(type => `<span class="tag">${eventTypeLabels[type] || type}</span>`).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="outfit-recommendation">
            <h4>Recommended Outfit</h4>
            <p>${data.recommendation || 'No outfit recommendation available.'}</p>
            ${data.reasoning ? `<p><strong>Why this outfit:</strong> ${data.reasoning}</p>` : ''}
          </div>
        `;
        
        // Show modal
        outfitModal.classList.add('show');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
      
      function hideOutfitModal() {
        outfitModal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
      }
      
      function populateFilters(events) {
        // Populate location filter
        const locations = [...new Set(events.map(e => e.location).filter(Boolean))].sort();
        locationFilter.innerHTML = '<option value="">All Locations</option>' + 
          locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
        
        // Populate topic filter from tags
        const topics = [...new Set(events.flatMap(e => e.tags || []).filter(Boolean))].sort();
        topicFilter.innerHTML = '<option value="">All Topics</option>' + 
          topics.map(topic => `<option value="${topic}">${topic}</option>`).join('');
      }
      
      function applyFilters() {
        const dayFilterValue = dayFilter.value;
        const locationFilterValue = locationFilter.value;
        const topicFilterValue = topicFilter.value;
        
        filteredEvents = allEvents.filter(event => {
          const dayMatch = !dayFilterValue || event.date?.includes(dayFilterValue) || 
                          getDayFromDate(event.date) === dayFilterValue;
          const locationMatch = !locationFilterValue || event.location === locationFilterValue;
          const topicMatch = !topicFilterValue || (event.tags && event.tags.includes(topicFilterValue));
          
          return dayMatch && locationMatch && topicMatch;
        });
        
        renderEvents();
      }
      
      function getDayFromDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString('en-US', { weekday: 'long' });
      }
      
      function sortEvents() {
        const sortBy = sortSelect.value;
        
        filteredEvents.sort((a, b) => {
          switch (sortBy) {
            case 'date':
              return new Date(a.date || 0) - new Date(b.date || 0);
            case 'time':
              return (a.time || '').localeCompare(b.time || '');
            case 'name':
              return (a.name || '').localeCompare(b.name || '');
            case 'relevance':
            default:
              return 0; // Keep original order for relevance
          }
        });
        
        renderEvents();
      }
      
      function renderEvents() {
        if (filteredEvents.length === 0) {
          eventsEl.innerHTML = `
            <div class="event">
              <div class="event-title">No Events Match Your Filters</div>
              <div class="event-meta">
                <span>Try adjusting your filters or clearing them to see more events.</span>
              </div>
            </div>
          `;
          return;
        }
        
        eventsEl.innerHTML = filteredEvents.map(r => `
          <div class="event">
              <div class="event-title">${r.name}</div>
              ${r.description ? `<div class="event-description">${r.description.length > 200 ? r.description.substring(0, 200) + '...' : r.description}</div>` : ''}
              <div class="event-meta">
                <span>üìÖ ${r.date || 'TBA'}</span>
                <span>üïê ${r.time || 'TBA'}</span>
                <span>üìç ${r.location || 'TBA'}</span>
                <span>üí∞ ${r.price || 'TBA'}</span>
              </div>
              <div class="event-host">üë§ Host: ${r.host || 'TBA'}</div>
              ${r.tags ? `<div class="event-tags">${r.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
              ${r.aiReason ? `<div class="event-reason"><strong>Why recommended:</strong> ${r.aiReason}</div>` : ''}
              <div><a href="${r.url}" target="_blank" rel="noopener" class="event-link">View details ‚Üí</a></div>
          </div>
        `).join('');
      }
      
      async function clearFilters() {
        dayFilter.value = '';
        locationFilter.value = '';
        topicFilter.value = '';
        sortSelect.value = 'relevance';
        
        // Fetch all events from database
        try {
          status.innerHTML = '<div class="loading"></div> Loading all events...';
          const resp = await fetch('/api/get-events?limit=1000');
          const data = await resp.json();
          if (data.ok && data.events) {
            allEvents = data.events.map(event => ({
              id: event.id,
              name: event.event_name,
              description: event.event_description,
              date: event.event_date,
              time: event.event_time,
              location: event.event_location,
              host: event.hosted_by,
              price: event.price,
              url: event.event_url,
              tags: event.event_tags,
              women_specific: event.women_specific,
              invite_only: event.invite_only
            }));
            filteredEvents = [...allEvents];
            populateFilters(allEvents);
            renderEvents();
            status.textContent = '';
          } else {
            // Fallback to current filtered events
            filteredEvents = [...allEvents];
            renderEvents();
            status.textContent = '';
          }
        } catch (error) {
          console.error('Error fetching all events:', error);
          // Fallback to current filtered events
          filteredEvents = [...allEvents];
          renderEvents();
          status.textContent = '';
        }
      }
      
      function renderAIReasoning() {
        if (!aiReasoning || !aiReasoning.overall) {
          aiReasoningEl.hidden = true;
          return;
        }
        
        reasoningContentEl.innerHTML = `
          <div class="reasoning-content">
            <strong>Overall Analysis:</strong> ${aiReasoning.overall || 'No overall reasoning provided'}<br><br>
            <strong>Event-Specific Reasoning:</strong>
            ${aiReasoning.events && aiReasoning.events.length > 0 ? aiReasoning.events.map(event => 
              `<div class="event-reason"><strong>${event.name}:</strong> ${event.reason}</div>`
            ).join('') : 'No event-specific reasoning provided'}
          </div>
        `;
        aiReasoningEl.hidden = false;
      }

      btn.addEventListener('click', recommend);
      outfitBtn.addEventListener('click', recommendOutfit);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) recommend(); });
      
      // Modal event listeners
      modalClose.addEventListener('click', hideOutfitModal);
      modalCloseBtn.addEventListener('click', hideOutfitModal);
      getAnotherOutfitBtn.addEventListener('click', () => {
        hideOutfitModal();
        recommendOutfit();
      });
      
      // Close modal when clicking outside
      outfitModal.addEventListener('click', (e) => {
        if (e.target === outfitModal) {
          hideOutfitModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && outfitModal.classList.contains('show')) {
          hideOutfitModal();
        }
      });
      
      // Filter and sort event listeners
      dayFilter.addEventListener('change', applyFilters);
      locationFilter.addEventListener('change', applyFilters);
      topicFilter.addEventListener('change', applyFilters);
      sortSelect.addEventListener('change', sortEvents);
      clearFiltersBtn.addEventListener('click', clearFilters);
    </script>
  </body>
  </html>

